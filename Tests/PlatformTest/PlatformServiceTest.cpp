#include <gtest/gtest.h>
#include <iostream>
#include <Common/Configuration.h>
#include "Services/DataFeedModule.h"
#include "Services/StorageModule.h"
#include <Platform/PlatformService.h>

#include <CPPServiceLocator/ServiceLocator.hpp>

using namespace PlatformTest::Services;
using namespace Platform;

TEST(Process_OrderBook_Test, BasicAssertions) {
    // DataFeed service.
    auto dataFeedLocator = ServiceLocator::create();
    dataFeedLocator->modules().add<DataFeedModule>();

    // Storage service
    auto storageLocator = ServiceLocator::create();
    storageLocator->modules().add<StorageModule>();

    vector<shared_ptr<IDataFeed>> feeds;
    vector<shared_ptr<IStorage>> storages;
    dataFeedLocator->getContext()->resolveAll<IDataFeed>(&feeds);
    storageLocator->getContext()->resolveAll<IStorage>(&storages);

    PlatformService p(dataFeedLocator, storageLocator);
    // There is no config used in Mock.
    // But actually we can config what datafeeds or storages should be enabled through configuration. Great extensibility!
    Configuration config;
    p.Start(config);

    // Create test data.
    /* This is copied from: wss://stream.binance.com:9443/ws/btcusdt@depth
    {"e":"depthUpdate","E":1623310293621,"s":"BTCUSDT","U":11585564872,"u":11585565101,"b":[["36823.65000000","0.00000000"],["36823.45000000","0.00000000"],["36823.44000000","0.00000000"],["36823.41000000","0.00000000"],["36822.46000000","0.00000000"],["36822.45000000","0.00054300"],["36822.44000000","0.00000000"],["36822.43000000","0.00000000"],["36821.60000000","0.10567500"],["36821.59000000","0.00000000"],["36821.58000000","0.00000000"],["36821.56000000","0.00000000"],["36821.55000000","0.00000000"],["36821.54000000","0.20128200"],["36821.25000000","0.00000000"],["36820.76000000","0.00000000"],["36820.75000000","0.17902600"],["36819.79000000","0.00000000"],["36819.75000000","0.02153800"],["36819.11000000","0.00000000"],["36818.96000000","0.00000000"],["36816.85000000","0.00100000"],["36816.18000000","0.77133500"],["36815.74000000","0.00000000"],["36815.50000000","0.25000000"],["36814.86000000","0.04000000"],["36814.82000000","0.00000000"],["36812.79000000","0.39999900"],["36810.46000000","0.00000000"],["36809.55000000","0.00000000"],["36807.58000000","0.27297000"],["36805.07000000","0.00000000"],["36804.22000000","0.00815100"],["36803.43000000","0.08266300"],["36803.38000000","0.78746600"],["36802.45000000","0.24435300"],["36798.51000000","0.00000000"],["36796.33000000","0.00000000"],["36795.56000000","0.19644900"],["36793.69000000","0.00000000"],["36791.79000000","0.04052100"],["36790.10000000","0.00000000"],["36788.58000000","0.00000000"],["36787.33000000","0.00000000"],["36786.99000000","0.35787200"],["36782.79000000","0.01386700"],["36778.33000000","0.00000000"],["36773.79000000","0.01561000"],["36767.00000000","0.88229900"],["36764.92000000","0.00000000"],["36638.31000000","0.00000000"],["36637.45000000","0.50000000"],["36336.21000000","0.00000000"],["36313.32000000","0.28933700"],["36300.00000000","28.27914100"],["36000.00000000","114.15045800"],["21000.00000000","344.00234100"]],"a":[["36821.55000000","0.00000000"],["36821.97000000","0.00000000"],["36822.44000000","0.00000000"],["36822.46000000","0.84767200"],["36823.66000000","0.82426100"],["36823.67000000","0.00000000"],["36824.20000000","0.00000000"],["36824.24000000","0.00000000"],["36824.46000000","0.23335600"],["36824.47000000","0.21000000"],["36824.58000000","0.00000000"],["36824.59000000","0.00000000"],["36824.66000000","0.10311100"],["36824.67000000","0.00000000"],["36824.68000000","0.00000000"],["36824.78000000","0.00142400"],["36824.79000000","0.00000000"],["36824.91000000","0.00000000"],["36825.24000000","0.00000000"],["36825.25000000","0.00000000"],["36825.26000000","0.00276200"],["36825.34000000","0.00000000"],["36825.94000000","0.02030200"],["36826.85000000","0.00000000"],["36826.93000000","0.27000000"],["36828.23000000","0.04614800"],["36828.24000000","0.08789900"],["36828.36000000","0.00000000"],["36828.57000000","0.00000000"],["36829.91000000","0.07293500"],["36832.09000000","0.11422900"],["36832.10000000","0.00400000"],["36832.52000000","0.00000000"],["36832.96000000","0.14134400"],["36832.97000000","0.13353700"],["36833.16000000","0.00000000"],["36834.63000000","1.24000000"],["36834.67000000","0.00000000"],["36834.73000000","0.00000000"],["36834.74000000","1.00000000"],["36834.82000000","0.00000000"],["36835.51000000","0.05431000"],["36836.30000000","0.05431300"],["36837.00000000","0.69700000"],["36837.16000000","0.00000000"],["36838.78000000","0.00000000"],["36840.20000000","0.00000000"],["36841.12000000","0.00000000"],["36842.74000000","0.68572000"],["36844.83000000","0.00000000"],["36844.88000000","0.00000000"],["36850.09000000","0.04000000"],["36850.34000000","0.00000000"],["36853.89000000","0.00000000"],["36853.90000000","2.35360900"],["36854.79000000","0.03280900"],["36859.34000000","0.00000000"],["36859.98000000","0.00000000"],["36861.62000000","0.00000000"],["36863.79000000","0.01394200"],["36866.62000000","0.05665400"],["36867.95000000","0.05665400"],["36868.34000000","0.00000000"],["36872.79000000","0.02317600"],["36877.34000000","0.00000000"],["36880.90000000","0.00000000"],["36882.99000000","0.88229800"],["36949.00000000","0.00507200"],["36963.00000000","0.00000000"],["36999.99000000","0.07163100"],["37006.54000000","0.00000000"],["37006.55000000","0.50000000"],["37038.81000000","0.00000000"],["37290.11000000","0.00000000"],["37337.17000000","0.28846000"],["38600.00000000","16.48040800"]]}
    {"e":"depthUpdate","E":1623310294621,"s":"BTCUSDT","U":11585565102,"u":11585565301,"b":[["36822.45000000","0.00000000"],["36821.60000000","0.00000000"],["36821.54000000","0.00000000"],["36820.75000000","0.00000000"],["36817.16000000","0.00000000"],["36815.93000000","0.50000000"],["36815.50000000","0.00000000"],["36815.41000000","0.00000000"],["36814.86000000","0.04000000"],["36814.81000000","0.16000000"],["36814.55000000","0.00000000"],["36814.42000000","0.28357700"],["36813.80000000","0.00000000"],["36813.35000000","0.22000000"],["36811.57000000","0.54450600"],["36811.56000000","0.10000000"],["36811.37000000","0.25000000"],["36811.15000000","0.00000000"],["36810.47000000","0.00000000"],["36810.30000000","0.32000000"],["36810.27000000","0.75000000"],["36810.08000000","0.00000000"],["36808.37000000","0.50451300"],["36808.29000000","1.00000000"],["36808.07000000","0.27138900"],["36804.23000000","0.00815100"],["36804.22000000","0.00000000"],["36796.40000000","0.02166400"],["36791.79000000","0.00000000"],["36789.78000000","0.00000000"],["36788.13000000","0.05431000"],["36787.40000000","0.01889500"],["36782.79000000","0.00000000"],["36778.40000000","0.02444100"],["36773.79000000","0.00000000"],["36772.53000000","0.11000000"],["36760.08000000","0.00000000"],["36759.03000000","0.03367600"],["36740.28000000","0.00000000"],["36735.69000000","0.22624800"],["36336.21000000","0.29433700"],["36313.32000000","0.00000000"],["33300.00000000","5.24848500"]],"a":[["36820.75000000","0.53302500"],["36820.76000000","0.00000000"],["36821.18000000","0.00000000"],["36821.50000000","0.10231700"],["36821.51000000","0.12439100"],["36821.55000000","0.06505300"],["36821.60000000","0.12862800"],["36821.61000000","0.06141900"],["36822.45000000","0.17804800"],["36822.46000000","0.51704800"],["36823.66000000","0.00000000"],["36824.07000000","0.02030200"],["36824.46000000","0.50335600"],["36824.47000000","0.21000000"],["36824.66000000","0.00054200"],["36824.78000000","0.00000000"],["36824.79000000","0.00000000"],["36824.82000000","0.00000000"],["36824.91000000","0.00000000"],["36825.34000000","0.00000000"],["36825.56000000","0.00000000"],["36825.94000000","0.00000000"],["36826.00000000","0.00000000"],["36826.93000000","0.00000000"],["36827.00000000","0.00000000"],["36827.85000000","0.00000000"],["36828.56000000","0.00000000"],["36829.90000000","0.29602200"],["36829.91000000","0.00000000"],["36831.17000000","0.05431000"],["36831.86000000","0.13353700"],["36832.05000000","0.56000000"],["36832.06000000","0.56363700"],["36832.07000000","0.00000000"],["36832.08000000","0.29601500"],["36832.09000000","0.00000000"],["36832.40000000","0.05431600"],["36832.41000000","0.00000000"],["36832.81000000","0.00000000"],["36832.97000000","0.00000000"],["36834.27000000","0.00000000"],["36834.68000000","0.00000000"],["36835.51000000","0.00000000"],["36836.30000000","0.00000000"],["36837.09000000","0.00000000"],["36839.64000000","0.05000000"],["36842.87000000","0.50000000"],["36845.58000000","0.00000000"],["36846.66000000","0.00000000"],["36849.38000000","0.00000000"],["36850.40000000","0.01331500"],["36853.89000000","0.00000000"],["36854.79000000","0.00000000"],["36855.17000000","7.42618600"],["36855.78000000","0.00000000"],["36859.09000000","0.24600000"],["36859.40000000","0.02859000"],["36863.79000000","0.00000000"],["36868.40000000","0.01542500"],["36872.79000000","0.00000000"],["36877.40000000","0.00260900"],["36884.83000000","0.00000000"],["36901.27000000","0.11000000"],["36902.27000000","0.00000000"],["36938.11000000","0.21900000"],["36978.70000000","0.00000000"],["37290.11000000","0.29844600"],["37337.17000000","0.00000000"],["38050.00000000","2.09378600"]]}
    {"e":"depthUpdate","E":1623310443628,"s":"BTCUSDT","U":11585604154,"u":11585604463,"b":[["36751.83000000","0.00000000"],["36750.96000000","0.00000000"],["36750.01000000","0.00000000"],["36750.00000000","10.42240600"],["36747.50000000","0.00000000"],["36746.95000000","0.00716200"],["36746.42000000","0.00000000"],["36745.00000000","0.00043300"],["36743.54000000","0.00027300"],["36743.31000000","0.27182400"],["36742.68000000","0.00028900"],["36740.54000000","0.02578400"],["36740.32000000","0.00000000"],["36739.51000000","0.00000000"],["36738.94000000","0.00000000"],["36738.55000000","0.00000000"],["36738.18000000","0.00000000"],["36737.60000000","0.00000000"],["36737.44000000","0.00000000"],["36737.35000000","0.00000000"],["36737.30000000","0.00000000"],["36737.06000000","0.00041600"],["36736.79000000","0.00000000"],["36735.52000000","0.00000000"],["36735.26000000","0.05442000"],["36733.78000000","0.00000000"],["36733.55000000","0.00000000"],["36733.36000000","0.00000000"],["36733.09000000","0.00200000"],["36733.04000000","0.00000000"],["36732.90000000","0.00000000"],["36732.47000000","0.00000000"],["36731.54000000","0.01593000"],["36731.06000000","0.69700000"],["36730.73000000","0.66000000"],["36730.50000000","0.08000000"],["36730.22000000","0.00000000"],["36729.35000000","1.00000000"],["36728.96000000","0.50000000"],["36728.73000000","0.75000000"],["36728.47000000","0.09000000"],["36728.45000000","0.81417800"],["36728.44000000","0.96204700"],["36727.77000000","0.00000000"],["36727.60000000","0.00000000"],["36727.56000000","0.09000000"],["36726.53000000","0.50000000"],["36726.13000000","0.00000000"],["36725.06000000","0.77665900"],["36724.73000000","0.00816900"],["36724.30000000","0.25000000"],["36724.14000000","0.00000000"],["36723.90000000","0.08000000"],["36722.54000000","0.02828400"],["36722.43000000","0.05000000"],["36721.44000000","0.30919800"],["36719.76000000","0.00000000"],["36719.44000000","0.00000000"],["36719.31000000","0.00000000"],["36711.45000000","0.00000000"],["36706.68000000","0.01417700"],["36705.11000000","0.45847000"],["36695.37000000","0.00000000"],["36689.46000000","0.88398200"],["36676.69000000","0.00000000"],["36669.45000000","0.05670900"],["36637.80000000","0.50000000"],["36560.00000000","2.02000000"],["36520.50000000","0.07612600"],["36282.03000000","0.00000000"],["36259.16000000","0.28962100"]],"a":[["36750.01000000","1.17571300"],["36750.03000000","0.01117000"],["36750.05000000","0.01117000"],["36750.97000000","0.00000000"],["36751.37000000","0.00000000"],["36751.38000000","0.00000000"],["36751.39000000","0.00000000"],["36751.40000000","0.00000000"],["36751.41000000","0.00000000"],["36751.42000000","0.00000000"],["36751.43000000","0.00000000"],["36751.44000000","0.00000000"],["36751.45000000","0.00000000"],["36751.46000000","0.00000000"],["36751.47000000","1.44554800"],["36751.48000000","0.00000000"],["36751.49000000","0.12197400"],["36751.83000000","0.00000000"],["36751.84000000","0.22773400"],["36752.15000000","2.91800000"],["36752.65000000","1.24800000"],["36752.74000000","0.03467900"],["36753.03000000","0.00000000"],["36753.57000000","0.00000000"],["36753.64000000","0.29659900"],["36753.65000000","0.00000000"],["36754.98000000","0.52376900"],["36754.99000000","0.27000000"],["36755.05000000","0.00000000"],["36755.69000000","0.19000000"],["36756.42000000","0.00306000"],["36756.44000000","0.00306000"],["36757.23000000","0.56000000"],["36757.24000000","0.60217600"],["36757.25000000","0.74700000"],["36757.29000000","0.00000000"],["36757.30000000","0.00000000"],["36757.48000000","0.40000000"],["36757.97000000","0.00000000"],["36757.98000000","0.00000000"],["36758.35000000","0.00000000"],["36758.36000000","0.13594400"],["36758.46000000","0.00000000"],["36759.02000000","0.50000000"],["36759.03000000","0.47367600"],["36759.04000000","0.29659900"],["36759.13000000","0.00000000"],["36759.18000000","0.05442000"],["36759.62000000","0.00000000"],["36759.97000000","0.00000000"],["36760.16000000","0.00000000"],["36760.17000000","0.00000000"],["36760.18000000","0.00000000"],["36760.25000000","0.00000000"],["36760.27000000","0.00000000"],["36760.55000000","0.00000000"],["36760.56000000","0.00000000"],["36761.29000000","0.00000000"],["36762.87000000","0.00000000"],["36763.06000000","0.00000000"],["36763.07000000","0.00000000"],["36763.27000000","0.00000000"],["36767.34000000","0.50877000"],["36767.40000000","0.00000000"],["36768.97000000","0.59288300"],["36769.36000000","0.85741000"],["36772.80000000","1.81764200"],["36772.91000000","0.25000000"],["36775.61000000","1.04024200"],["36778.65000000","0.00000000"],["36780.72000000","0.39600000"],["36781.61000000","0.00000000"],["36781.98000000","0.00000000"],["36782.95000000","0.00000000"],["36784.40000000","0.25700000"],["36785.26000000","0.02718500"],["36785.62000000","0.00000000"],["36786.61000000","1.40300000"],["36790.81000000","0.00000000"],["36791.51000000","0.00000000"],["36794.54000000","0.00907200"],["36800.45000000","0.00000000"],["36803.54000000","0.03050300"],["36804.55000000","0.27100000"],["36805.20000000","0.88398200"],["36807.27000000","0.00000000"],["36809.45000000","0.00000000"],["36811.14000000","0.00000000"],["36812.54000000","0.01944700"],["36818.45000000","0.00000000"],["36820.05000000","0.00000000"],["36821.54000000","0.00591200"],["36911.00000000","0.00534300"],["36917.00000000","0.00000000"],["37082.78000000","0.01106900"],["37082.79000000","0.03179600"],["37234.63000000","0.00000000"],["37258.64000000","0.29373600"],["50481.08000000","0.00000000"]]}
    {"e":"depthUpdate","E":1623310444628,"s":"BTCUSDT","U":11585604464,"u":11585604553,"b":[["36750.00000000","10.13592700"],["36743.13000000","0.03200000"],["36742.68000000","0.00028900"],["36734.80000000","0.13292500"],["36733.09000000","0.27391800"],["36733.06000000","0.50000000"],["36728.45000000","0.81417800"],["36706.68000000","0.00000000"],["36568.04000000","0.00000000"],["36566.25000000","0.50000000"],["36500.00000000","10.22377500"],["36483.72000000","0.38598600"],["36419.26000000","0.00822300"],["36235.50000000","0.13774400"],["35893.33000000","0.02721000"],["31514.01000000","0.00244300"],["28888.00000000","48.05118000"]],"a":[["36750.01000000","2.72231000"],["36750.02000000","2.00000000"],["36751.35000000","0.27100000"],["36751.47000000","0.38730600"],["36751.49000000","0.00000000"],["36755.36000000","0.00000000"],["36755.38000000","0.00000000"],["36756.42000000","0.00272000"],["36756.44000000","0.00000000"],["36757.12000000","0.13353700"],["36757.23000000","0.00000000"],["36759.05000000","0.02631700"],["36759.18000000","0.00000000"],["36767.02000000","0.80409800"],["36767.33000000","0.92654100"],["36767.77000000","0.08208200"],["36770.00000000","0.06921000"],["36770.93000000","7.42618600"],["36770.94000000","0.00000000"],["36770.95000000","0.00000000"],["36771.70000000","0.00000000"],["36773.74000000","0.00000000"],["36775.61000000","0.00000000"],["36775.86000000","0.00000000"],["36784.20000000","0.00000000"],["36805.08000000","0.00284900"],["36906.58000000","0.00000000"],["36928.00000000","0.00000000"],["36933.76000000","0.50000000"],["36935.57000000","0.00000000"],["37000.00000000","13.52702300"],["37135.68000000","0.00884100"],["37135.69000000","0.02540000"]]}
    */

    p.Stop();
}